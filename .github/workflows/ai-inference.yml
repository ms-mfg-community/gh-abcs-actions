---
name: 08-1. AI Inference

on:
  push:
    branches:
      - "feature/**"
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      code_to_review:
        description: "Code snippet to review"
        required: false
        default: "function add(a, b) { return a + b; }"

permissions:
  models: read

jobs:
  inference:
    name: AI Inference
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run AI Code Review
        id: ai
        uses: actions/ai-inference@v1
        with:
          prompt-file: .github/prompts/code-review.prompt.yml
          input: |
            code_snippet: >-
              ${{ github.event.inputs.code_to_review ||
              'function add(a, b) { return a + b; }' }}
          max-tokens: 500

      - name: Display Raw Response
        run: |
          echo "Raw JSON response:"
          echo '${{ steps.ai.outputs.response }}'

      - name: Parse and Display Review
        run: |
          echo "=== Parsed Code Review ==="
          echo ""
          echo "Summary: $(echo '${{ steps.ai.outputs.response }}' | jq -r '.summary')"
          echo "Score: $(echo '${{ steps.ai.outputs.response }}' | jq -r '.score')/10"
          echo ""
          echo "Issues found:"
          echo '${{ steps.ai.outputs.response }}' | jq -r '.issues[] | "  - [\(.severity)] \(.description)"'
          echo ""
          echo "Top suggestion: $(echo '${{ steps.ai.outputs.response }}' | jq -r '.suggestion')"

      - name: Use Score in Conditional
        run: |
          SCORE=$(echo '${{ steps.ai.outputs.response }}' | jq -r '.score')
          if [ "$SCORE" -ge 7 ]; then
            echo "✅ Code quality is good (score: $SCORE)"
          else
            echo "⚠️ Code needs improvement (score: $SCORE)"
          fi

  # Optional: MCP Integration Demo (requires PAT)
  # This job only runs if ENABLE_MCP_DEMO variable is set to 'true'
  mcp-demo:
    name: MCP Demo (Optional)
    runs-on: ubuntu-latest
    if: ${{ vars.ENABLE_MCP_DEMO == 'true' }}
    steps:
      - name: Run AI with Repository Context
        id: mcp-ai
        uses: actions/ai-inference@v1
        with:
          prompt: |
            You have access to this repository's context via MCP.
            Please list the open issues in this repository, including their
            numbers and titles. If there are no open issues, say so.
          max-tokens: 500
          enable-github-mcp: true
          github-mcp-token: ${{ secrets.GH_MCP_TOKEN }}
          github-mcp-toolsets: repos,issues,pull_requests

      - name: Display MCP Response
        run: |
          echo "=== AI Response with Repository Context ==="
          echo "${{ steps.mcp-ai.outputs.response }}"
